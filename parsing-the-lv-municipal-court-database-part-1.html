<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>James Estevez | Parsing the LV Municipal Court database, part 1</title>
  <meta property="og:type" content="article" />
  <meta name="description" content="Parsing the LVMC Case Summary Report Finally got the time to put together the omnibus post I had mentioned in the previous entry. Doing this in R for two reasons: first, because I'm rather not get rusty with R (Anki helps), and second, as I mentioned, to get some ..." />
    <meta property="article:tag" content="[scraping" />
    <meta property="article:tag" content="R" />
    <meta property="article:tag" content="dataset]" />
    <link rel="stylesheet" href="/theme/css/main.css" />
    <link rel="stylesheet" href="/theme/fonts/main.css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body id="index" class="home">
    <div id="wrapper">
        <header id="banner" class="body">
            <h1><a href="/">James Estevez</a></h1>
            <br/><nav><ul>
            </ul></nav>
        </header>
<section id="content" class="body">
  <article class="container">
    <header>
      <h1 class="entry-title">Parsing the LV Municipal Court database, part 1</h1>
      <span class="date">Mon 26 August 2013</span>
    </header>

    <div class="entry-content">
      <h2>Parsing the LVMC Case Summary Report</h2>
<p>Finally got the time to put together the omnibus post I had mentioned in
the previous entry. Doing this in R for two reasons: first, because I'm
rather not get rusty with R (Anki helps), and second, as I mentioned, to
get some experience with the <code>XML</code> library.</p>
<h2>Preliminaries and scraping</h2>
<p>Here we load the library and select all tables nested within a parent
table cell in the tree.</p>
<div class="highlight"><pre><span class="kn">library</span><span class="p">(</span>XML<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span><span class="s">&quot;data.table&quot;</span><span class="p">,</span> lib.loc <span class="o">=</span> <span class="s">&quot;/home/james/R&quot;</span><span class="p">)</span>
<span class="kn">library</span><span class="p">(</span><span class="s">&quot;plyr&quot;</span><span class="p">,</span> lib.loc <span class="o">=</span> <span class="s">&quot;/home/james/R&quot;</span><span class="p">)</span>
<span class="kn">library</span><span class="p">(</span><span class="s">&quot;ggplot2&quot;</span><span class="p">,</span> lib.loc <span class="o">=</span> <span class="s">&quot;/home/james/R&quot;</span><span class="p">)</span>
<span class="kn">library</span><span class="p">(</span><span class="s">&quot;stringr&quot;</span><span class="p">,</span> lib.loc <span class="o">=</span> <span class="s">&quot;/home/james/R&quot;</span><span class="p">)</span>
<span class="kn">library</span><span class="p">(</span><span class="s">&quot;xtable&quot;</span><span class="p">,</span> lib.loc <span class="o">=</span> <span class="s">&quot;/home/james/R&quot;</span><span class="p">)</span>
</pre></div>


<p>We can make use of the script we used, and include it in its entirety
thanks to the knitr python engine.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>

<span class="k">def</span> <span class="nf">get_lvmc_case_report</span><span class="p">(</span><span class="n">caseNumber</span><span class="p">):</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;https://secure2.lasvegasnevada.gov/defendantreport/Default.aspx&#39;</span><span class="p">)</span>
    <span class="n">casenum</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s">&#39;txt_CaseNo&#39;</span><span class="p">)</span>
    <span class="n">casenum</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">caseNumber</span><span class="p">)</span>
    <span class="n">casenum</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="n">driver</span><span class="o">.</span><span class="n">window_handles</span><span class="p">:</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">switch_to_window</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">driver</span><span class="o">.</span><span class="n">current_url</span> <span class="o">==</span> <span class="s">&#39;https://secure2.lasvegasnevada.gov/defendantreport/report.aspx&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">caseNumber</span> <span class="o">+</span> <span class="s">&#39;.html.gz&#39;</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Wrote </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;A&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000001</span><span class="p">,</span> <span class="mi">1099263</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">case</span>
    <span class="n">get_lvmc_case_report</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
    <span class="c"># The time it takes to open a browser window is enough,</span>
    <span class="c"># no need to sleep</span>
    <span class="c"># sleep(randint(0,1))</span>
</pre></div>


<p>See the original <a href="/notebook/2013/08/scraping-an-aspx-page-with-python-and-selenium">scraping
post</a>
for documentation.</p>
<div class="highlight"><pre>results.list <span class="o">&lt;-</span> <span class="kp">list.files</span><span class="p">(</span>path <span class="o">=</span> <span class="s">&quot;/home/james/Dropbox/legal/scraping/lvmc&quot;</span><span class="p">,</span> 
    pattern <span class="o">=</span> <span class="s">&quot;*.html.gz&quot;</span><span class="p">,</span> recursive <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> full.names <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="kp">names</span><span class="p">(</span>results.list<span class="p">)</span> <span class="o">&lt;-</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;/home/james/Dropbox/legal/scraping/lvmc/\\d\\d/(C\\d+A).html.gz&quot;</span><span class="p">,</span> 
    <span class="s">&quot;\\1&quot;</span><span class="p">,</span> results.list<span class="p">)</span>
<span class="kp">head</span><span class="p">(</span>results.list<span class="p">)</span>
</pre></div>


<div class="highlight"><pre>##                                                      C1000001A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/00/C1000001A.html.gz&quot; 
##                                                      C1000002A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/00/C1000002A.html.gz&quot; 
##                                                      C1000003A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/00/C1000003A.html.gz&quot; 
##                                                      C1000004A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/00/C1000004A.html.gz&quot; 
##                                                      C1000005A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/00/C1000005A.html.gz&quot; 
##                                                      C1000006A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/00/C1000006A.html.gz&quot;
</pre></div>


<div class="highlight"><pre><span class="kp">tail</span><span class="p">(</span>results.list<span class="p">)</span>
</pre></div>


<div class="highlight"><pre>##                                                      C1099255A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/05/C1099255A.html.gz&quot; 
##                                                      C1099259A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/05/C1099259A.html.gz&quot; 
##                                                      C1099260A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/05/C1099260A.html.gz&quot; 
##                                                      C1099261A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/05/C1099261A.html.gz&quot; 
##                                                      C1099262A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/05/C1099262A.html.gz&quot; 
##                                                      C1099263A 
## &quot;/home/james/Dropbox/legal/scraping/lvmc/05/C1099263A.html.gz&quot;
</pre></div>


<p>It wasn't necessary to download local copies of our files; we could have
constructed and fed the URLs directly into the <code>XML</code> parser, we'd just
replace the following strings with the appropriate URL generator.<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
<div class="highlight"><pre>TreeParse <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
    tree <span class="o">&lt;-</span> htmlTreeParse<span class="p">(</span>x<span class="p">,</span> useInternalNodes <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> asText <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
    srctbl <span class="o">&lt;-</span> getNodeSet<span class="p">(</span>tree<span class="p">,</span> <span class="s">&quot;//span/div/table/tbody/tr/td/table&quot;</span><span class="p">)</span>
    <span class="kr">return</span><span class="p">(</span>srctbl<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h2>Case Identifiers</h2>
<p>We also create a class for the LVMC's date format:</p>
<div class="highlight"><pre>setClass<span class="p">(</span><span class="s">&quot;caseDate&quot;</span><span class="p">)</span>
setAs<span class="p">(</span><span class="s">&quot;character&quot;</span><span class="p">,</span> <span class="s">&quot;caseDate&quot;</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span>from<span class="p">)</span> <span class="kp">as.POSIXct</span><span class="p">(</span>from<span class="p">,</span> format <span class="o">=</span> <span class="s">&quot;%m/%d/%Y %I:%M %p&quot;</span><span class="p">))</span>
</pre></div>


<p>And for the ID table, we need to split table cells by colon.</p>
<div class="highlight"><pre>pairVectors <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
    <span class="c1"># Splits cells from the identifiers table of LVMC case reports into</span>
    <span class="c1"># variables</span>
    <span class="c1"># </span>
    <span class="c1"># Args: x: A single character string to be split on its colon &#39;Court Date:</span>
    <span class="c1"># 10/4/2012 8:30 AM&#39;</span>
    <span class="c1"># </span>
    <span class="c1"># Returns: A single-column data frame</span>
    name <span class="o">&lt;-</span> <span class="kp">sub</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="kp">tolower</span><span class="p">(</span>x<span class="p">[</span><span class="m">1</span><span class="p">]))</span>
    <span class="kr">if</span> <span class="p">(</span>name <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;violation.date&quot;</span><span class="p">,</span> <span class="s">&quot;court.date&quot;</span><span class="p">))</span> <span class="p">{</span>
        val <span class="o">&lt;-</span> <span class="kp">as.POSIXct</span><span class="p">(</span>x<span class="p">[</span><span class="m">2</span><span class="p">],</span> format <span class="o">=</span> <span class="s">&quot;%m/%d/%Y %I:%M %p&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        val <span class="o">&lt;-</span> x<span class="p">[</span><span class="m">2</span><span class="p">]</span>
    <span class="p">}</span>
    out <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>val<span class="p">)</span>
    <span class="kp">names</span><span class="p">(</span>out<span class="p">)</span> <span class="o">&lt;-</span> name
    <span class="kr">return</span><span class="p">(</span>out<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>And we include that function in the main one extracting entries from the
third table of the case summary.</p>
<div class="highlight"><pre>extractIdentifiers <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span><span class="kp">raw</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1"># Parses the identifiers table (no. 3) of LVMC case reports</span>
    <span class="c1"># </span>
    <span class="c1"># Args: ids.raw: An XML node set containing a single HTML table</span>
    <span class="c1"># </span>
    <span class="c1"># Returns: A data frame containing: history.number case.number</span>
    <span class="c1"># citation.number violation violation.date name department court.date</span>

    <span class="c1"># Extract the table containing case identifiers</span>
    ids.raw.df <span class="o">&lt;-</span> readHTMLTable<span class="p">(</span><span class="kp">raw</span><span class="p">[[</span><span class="m">3</span><span class="p">]],</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
    <span class="c1"># Split each cell into id:value pairs. Not every case has a citation</span>
    <span class="c1"># number so we split on a colon ending a line or followed by a space</span>
    ids.raw.lst <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="kp">strsplit</span><span class="p">(</span>ids.raw.df<span class="o">$</span>V1<span class="p">,</span> <span class="s">&quot;: |:$&quot;</span><span class="p">),</span> <span class="kp">strsplit</span><span class="p">(</span>ids.raw.df<span class="o">$</span>V2<span class="p">[</span><span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>ids.raw.df<span class="o">$</span>V2<span class="p">)],</span> 
        <span class="s">&quot;: |:$&quot;</span><span class="p">))</span>
    <span class="c1"># Combine each id:value string vector into a data frame</span>
    ids.pairs <span class="o">&lt;-</span> <span class="kp">sapply</span><span class="p">(</span>ids.raw.lst<span class="p">,</span> pairVectors<span class="p">)</span>
    <span class="c1"># Merge the list of data frames and exit</span>
    ids <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>ids.pairs<span class="p">)</span>
    <span class="kr">return</span><span class="p">(</span>ids<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h2>Case Docket</h2>
<p>This table is a bit more complex in that a lot of the data we're after
is encoded in the case activity column as id:value pairs (<em>e.g.</em>,
<code>Plea: NOLO</code> or <code>Finding: GUILTY</code>). We could repeat the steps we used to
extract the <code>ids</code> table, but there's additional data that doesn't seem
to obey the colon delimited format, most importantly the type of
attorney (<code>Public Attorney SMITH, BRIAN Bar# 11279</code>).</p>
<p>Activity entry                                                  Variables                                                                                Type</p>
<hr />
<p>Case Closed                                                     <code>case.closed = TRUE</code>                                                                     logical
  Plea: NOLO)                                                     <code>plea=NC</code> or (<code>NG, GT, SU</code>)                                                              factor
  Finding: GUILTY                                                 <code>finding=GT</code>or (<code>NG</code>, <code>DS</code>?)                                                             factor
  Probable Cause Found                                            <code>pc.hearing=TRUE, pc.found=TRUE</code>                                                         logical
  Bail Due: \$1130                                                <code>bail due=1130</code>                                                                          numeric
  Sentence: JAIL 3 days CTS: 3 days                               <code>list("sentence.type"=J, "sentence.val"=3, "sentence.suspended"=FALSE), jail.served=3</code>   list,numeric
  Complaint Filed 12/2/2010 9:10 AM                               <code>complaint.date=date</code>                                                                    POSIXct
  Public Attorney SMITH, BRIAN Bar# 11279                        <code>attorney.type=(PDR,PVT), attorney.name="SMITH, BRIAN",attorney.bar=11279</code>               factor
  BW Ordered                                                      <code>bw.issued=TRUE</code>                                                                         logical
  Suspend Sentence for 1Y <code>AND</code> Sentence: Suspend JAIL 179 days   `<code>list("sentence.type"=J, "sentence.val"=3, "sentence.suspended"=TRUE)</code>                 list</p>
<p>There's a separate table for sentences, so we'll set that aside for the
moment. We begin by establishing whether the case is closed, and whether
the court conducted a <a href="http://en.wikipedia.org/wiki/Probable_cause#Probable_cause_hearings">probable cause
hearing</a>:</p>
<div class="highlight"><pre>isClosed <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>docket.df<span class="p">)</span> <span class="p">{</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Case Closed&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        case.closed <span class="o">&lt;-</span> <span class="kc">FALSE</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        case.closed <span class="o">&lt;-</span> <span class="kc">TRUE</span>
    <span class="p">}</span>
    <span class="kr">return</span><span class="p">(</span>case.closed<span class="p">)</span>
<span class="p">}</span>

GetProbableCause <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>docket.df<span class="p">)</span> <span class="p">{</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Probable Cause&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="o">==</span> 
        <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        pc.hearing.held <span class="o">&lt;-</span> <span class="kc">FALSE</span>
        pc.found <span class="o">&lt;-</span> <span class="kc">NA</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        pc.hearing.held <span class="o">&lt;-</span> <span class="kc">TRUE</span>
        <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Probable Cause Found&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> 
            ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
            pc.found <span class="o">&lt;-</span> <span class="kc">TRUE</span>
        <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
            pc.found <span class="o">&lt;-</span> <span class="kc">FALSE</span>
        <span class="p">}</span>
    <span class="p">}</span>
    pc.hearing <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>pc.hearing.held<span class="p">,</span> pc.found<span class="p">)</span>
    <span class="kr">return</span><span class="p">(</span>pc.hearing<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>Getting the attorney name and type requires extracting it via regex. We
also have to consider that multiple attorney entries may exist, as when
a private attorney is replaced by a publicly provided one. We can do
this by setting up the function to only record the first (most recent)
entry, and to set certain logical flags if there are multiple attorneys.</p>
<div class="highlight"><pre>parseAttorneyName <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>atty.str<span class="p">)</span> <span class="p">{</span>
    atty.str <span class="o">&lt;-</span> <span class="kp">sub</span><span class="p">(</span><span class="s">&quot;(Public|Private) Attorney ([A-Za-z]+, [A-Za-z]+|[A-Za-z]+, [A-Za-z]+ [A-Za-z]\\.) Bar# (\\d+)&quot;</span><span class="p">,</span> 
        <span class="s">&quot;\\2~\\3&quot;</span><span class="p">,</span> atty.str<span class="p">)</span>
    atty.entry <span class="o">&lt;-</span> <span class="kp">unlist</span><span class="p">(</span><span class="kp">strsplit</span><span class="p">(</span>atty.str<span class="p">,</span> <span class="s">&quot;~&quot;</span><span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
    a <span class="o">&lt;-</span> <span class="kt">list</span><span class="p">(</span>attorney.name <span class="o">=</span> atty.entry<span class="p">[</span><span class="m">1</span><span class="p">],</span> attorney.bar.num <span class="o">=</span> atty.entry<span class="p">[</span><span class="m">2</span><span class="p">])</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>a<span class="p">)</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># check for a nam</span>
        <span class="kr">return</span><span class="p">(</span>a<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        a <span class="o">&lt;-</span> <span class="kt">list</span><span class="p">(</span>attorney.name <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> attorney.bar.num <span class="o">=</span> <span class="kc">NA</span><span class="p">)</span>
        <span class="kr">return</span><span class="p">(</span>a<span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

getAttorney <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>docket.df<span class="p">)</span> <span class="p">{</span>
    <span class="c1"># Parses the case docket for attorney of record entries in LVMC case</span>
    <span class="c1"># reports</span>
    <span class="c1"># </span>
    <span class="c1"># Args: docket.df: data frame with date and activity cols</span>
    <span class="c1"># </span>
    <span class="c1"># Returns: A data frame containing: Attorney Name, if mult, first (latest)</span>
    <span class="c1"># attorney bar number, if mult, first (latest) assigned counsel multiple</span>
    <span class="c1"># attorneys</span>

    pri.len <span class="o">&lt;-</span> <span class="kp">length</span><span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Private Attorney&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
    pub.len <span class="o">&lt;-</span> <span class="kp">length</span><span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Public Attorney&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
    <span class="kr">if</span> <span class="p">(</span>pri.len <span class="o">==</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> pub.len <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># No attorney</span>
        atty <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>attorney.is.assigned <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> attorney.is.private <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> 
            attorney.name <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> attorney.bar.num <span class="o">=</span> <span class="kc">NA</span><span class="p">)</span>
        <span class="kr">return</span><span class="p">(</span>atty<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span> <span class="p">(</span>pub.len <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># public attorney</span>
        atty.name <span class="o">&lt;-</span> parseAttorneyName<span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Public Attorney&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> 
            value <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
        atty <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>attorney.is.assigned <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> attorney.is.private <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> 
            atty.name<span class="p">,</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
        <span class="kr">return</span><span class="p">(</span>atty<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span> <span class="p">(</span>pri.len <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># private attorney</span>
        atty.name <span class="o">&lt;-</span> parseAttorneyName<span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Private Attorney&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> 
            value <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
        atty <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>attorney.is.assigned <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> attorney.is.private <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> 
            atty.name<span class="p">,</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
        <span class="kr">return</span><span class="p">(</span>atty<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        atty <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>attorney.is.assigned <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> attorney.is.private <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> 
            attorney.name <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> attorney.bar.num <span class="o">=</span> <span class="kc">NA</span><span class="p">)</span>
        <span class="kr">return</span><span class="p">(</span>atty<span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>


<p>Here we create a simpler version of the <code>pairVectors</code> function, which
we'll use to extract pleas and findings (verdicts). We also want to
check whether the City Attorney declines to pursue charges and/or the
court dismissed the charge.<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup></p>
<div class="highlight"><pre>activitySplit <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> str_trim<span class="p">(</span><span class="kp">unlist</span><span class="p">(</span><span class="kp">strsplit</span><span class="p">(</span>x<span class="p">,</span> <span class="s">&quot;: |:$&quot;</span><span class="p">)))</span>

isDenied <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>docket.df<span class="p">)</span> <span class="p">{</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;(Charge Denied|(Case|Charge) dismissed)&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> 
        ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        charge.denied <span class="o">&lt;-</span> <span class="kc">FALSE</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        charge.denied <span class="o">&lt;-</span> <span class="kc">TRUE</span>
    <span class="p">}</span>
    <span class="kr">return</span><span class="p">(</span>charge.denied<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>Putting it all together, we have:</p>
<div class="highlight"><pre>parseDocket <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>docket.df<span class="p">)</span> <span class="p">{</span>
    charge.denied <span class="o">&lt;-</span> isDenied<span class="p">(</span>docket.df<span class="p">)</span>
    <span class="kr">if</span> <span class="p">(</span>charge.denied<span class="p">)</span> <span class="p">{</span>
        finding <span class="o">&lt;-</span> plea <span class="o">&lt;-</span> <span class="s">&quot;NONE&quot;</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        plea <span class="o">&lt;-</span> activitySplit<span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Plea&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> value <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))[</span><span class="m">2</span><span class="p">]</span>
        finding <span class="o">&lt;-</span> activitySplit<span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Finding&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> value <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))[</span><span class="m">2</span><span class="p">]</span>
        <span class="kp">try</span><span class="p">(</span><span class="kr">if</span> <span class="p">(</span>plea <span class="o">==</span> <span class="s">&quot;Plea&quot;</span> <span class="o">||</span> finding <span class="o">==</span> <span class="s">&quot;Finding&quot;</span><span class="p">)</span> <span class="p">{</span>
            plea <span class="o">&lt;-</span> activitySplit<span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Plea&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> value <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))[</span><span class="m">3</span><span class="p">]</span>
            finding <span class="o">&lt;-</span> activitySplit<span class="p">(</span><span class="kp">grep</span><span class="p">(</span><span class="s">&quot;Finding&quot;</span><span class="p">,</span> docket.df<span class="o">$</span>activity<span class="p">,</span> value <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))[</span><span class="m">3</span><span class="p">]</span>
        <span class="p">})</span>
    <span class="p">}</span>
    attorney <span class="o">&lt;-</span> getAttorney<span class="p">(</span>docket.df<span class="p">)</span>
    pc.hearing <span class="o">&lt;-</span> GetProbableCause<span class="p">(</span>docket.df<span class="p">)</span>
    dkt <span class="o">&lt;-</span> <span class="kp">as.data.frame</span><span class="p">(</span><span class="kt">list</span><span class="p">(</span>charge.denied <span class="o">=</span> charge.denied<span class="p">,</span> plea <span class="o">=</span> plea<span class="p">,</span> finding <span class="o">=</span> finding<span class="p">))</span>
    dkt <span class="o">&lt;-</span> <span class="kp">cbind</span><span class="p">(</span>dkt<span class="p">,</span> attorney<span class="p">,</span> pc.hearing<span class="p">)</span>
    <span class="kr">return</span><span class="p">(</span>dkt<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>We first detect whether the charges have been denied, and, if so, skip
the plea and verdict. Because these are sometimes prefaced by
"<code>Correction:</code>" we select the third element when we extract the word
"plea" or "finding." We then get our attorney data and PC hearing
status. We <code>cbind</code> these together into a single data frame and return
it.</p>
<p>Depending on whether various flags (bench warrants, clerk flags or
alerts, etc.) have been set, the location of the docket can vary by up
to three slots. But because the record flags are one column HTML tables
we can check for the two columns of our docket table ("Activity date"
and "Activity"). We set <code>stringsAsFactors = FALSE</code> to keep the attorney
entries from being returned as a factor and subsequently being converted
into an integer when the data frames are combined.</p>
<div class="highlight"><pre>extractDocket <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>raw.tree<span class="p">)</span> <span class="p">{</span>
    docket.raw.df <span class="o">&lt;-</span> readHTMLTable<span class="p">(</span>raw.tree<span class="p">[[</span><span class="m">5</span><span class="p">]],</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> 
        skip.rows <span class="o">=</span> <span class="m">1</span><span class="p">,</span> header <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> colClasses <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;caseDate&quot;</span><span class="p">,</span> <span class="s">&quot;character&quot;</span><span class="p">))</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>docket.raw.df<span class="p">)</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="kp">names</span><span class="p">(</span>docket.raw.df<span class="p">)</span> <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;activity.date&quot;</span><span class="p">,</span> <span class="s">&quot;activity&quot;</span><span class="p">)</span>
        docket.dt <span class="o">&lt;-</span> as.data.table<span class="p">(</span>docket.raw.df<span class="p">)</span>
        <span class="kr">return</span><span class="p">(</span>docket.dt<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        docket.raw.df <span class="o">&lt;-</span> readHTMLTable<span class="p">(</span>raw.tree<span class="p">[[</span><span class="m">6</span><span class="p">]],</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> 
            skip.rows <span class="o">=</span> <span class="m">1</span><span class="p">,</span> header <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> colClasses <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;caseDate&quot;</span><span class="p">,</span> <span class="s">&quot;character&quot;</span><span class="p">))</span>
        <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>docket.raw.df<span class="p">)</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="kp">names</span><span class="p">(</span>docket.raw.df<span class="p">)</span> <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;activity.date&quot;</span><span class="p">,</span> <span class="s">&quot;activity&quot;</span><span class="p">)</span>
            docket.dt <span class="o">&lt;-</span> as.data.table<span class="p">(</span>docket.raw.df<span class="p">)</span>
            <span class="kr">return</span><span class="p">(</span>docket.dt<span class="p">)</span>
        <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
            docket.raw.df <span class="o">&lt;-</span> readHTMLTable<span class="p">(</span>raw.tree<span class="p">[[</span><span class="m">7</span><span class="p">]],</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> 
                skip.rows <span class="o">=</span> <span class="m">1</span><span class="p">,</span> header <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> colClasses <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;caseDate&quot;</span><span class="p">,</span> <span class="s">&quot;character&quot;</span><span class="p">))</span>
            <span class="kp">names</span><span class="p">(</span>docket.raw.df<span class="p">)</span> <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;activity.date&quot;</span><span class="p">,</span> <span class="s">&quot;activity&quot;</span><span class="p">)</span>
            docket.dt <span class="o">&lt;-</span> as.data.table<span class="p">(</span>docket.raw.df<span class="p">)</span>
            <span class="kr">return</span><span class="p">(</span>docket.dt<span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>We put all of that together:</p>
<div class="highlight"><pre>ParseSummaryTree <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>chr<span class="p">)</span> <span class="p">{</span>
    node <span class="o">&lt;-</span> TreeParse<span class="p">(</span>chr<span class="p">)</span>
    docket.df <span class="o">&lt;-</span> extractDocket<span class="p">(</span>node<span class="p">)</span>
    case.closed <span class="o">&lt;-</span> isClosed<span class="p">(</span>docket.df<span class="p">)</span>
    <span class="kr">if</span> <span class="p">(</span>case.closed<span class="p">)</span> <span class="p">{</span>
        ids <span class="o">&lt;-</span> extractIdentifiers<span class="p">(</span>node<span class="p">)</span>
        dkt <span class="o">&lt;-</span> parseDocket<span class="p">(</span>docket.df<span class="p">)</span>
        case <span class="o">&lt;-</span> <span class="kp">cbind</span><span class="p">(</span>ids<span class="p">,</span> dkt<span class="p">)</span>
        <span class="kr">return</span><span class="p">(</span>case<span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This returns a one row data frame containing:</p>
<ul>
<li><code>history.number</code></li>
<li><code>case.number</code></li>
<li><code>citation.number</code></li>
<li><code>violation</code></li>
<li><code>violation.date</code></li>
<li><code>name</code></li>
<li><code>department</code></li>
<li><code>court.date</code>\</li>
<li><code>charge.denied</code></li>
<li><code>plea</code></li>
<li><code>finding</code></li>
<li><code>attorney.is.assigned</code></li>
<li><code>attorney.is.private</code></li>
<li><code>attorney.name</code>\</li>
<li><code>attorney.bar.num</code>\</li>
<li><code>pc.hearing.held</code></li>
<li><code>pc.found</code></li>
</ul>
<h3>Extract the dockets</h3>
<p>My original approach kept all of the XMLNodeSets in memory, a mistake
that quickly filled up 8GB of RAM.</p>
<div class="highlight"><pre><span class="kn">library</span><span class="p">(</span><span class="s">&quot;parallel&quot;</span><span class="p">,</span> lib.loc <span class="o">=</span> <span class="s">&quot;/usr/lib/R/library&quot;</span><span class="p">)</span>

<span class="kr">if</span> <span class="p">(</span><span class="kp">file.exists</span><span class="p">(</span><span class="s">&quot;docketsDT.RData&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kp">load</span><span class="p">(</span><span class="s">&quot;docketsDT.RData&quot;</span><span class="p">)</span>
<span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
    <span class="kp">system.time</span><span class="p">(</span>dockets.l <span class="o">&lt;-</span> mclapply<span class="p">(</span>results.list<span class="p">,</span> ParseSummaryTree<span class="p">))</span>
    <span class="kp">system.time</span><span class="p">(</span>dockets <span class="o">&lt;-</span> <span class="kp">do.call</span><span class="p">(</span><span class="s">&quot;rbind&quot;</span><span class="p">,</span> dockets.l<span class="p">))</span>
    dockets.DT <span class="o">&lt;-</span> data.table<span class="p">(</span>dockets<span class="p">,</span> key <span class="o">=</span> <span class="s">&quot;case.number&quot;</span><span class="p">)</span>
    <span class="kp">save</span><span class="p">(</span>dockets.DT<span class="p">,</span> file <span class="o">=</span> <span class="s">&quot;docketsDT.RData&quot;</span><span class="p">,</span> compress <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
    write.csv<span class="p">(</span>dockets<span class="p">,</span> file <span class="o">=</span> <span class="s">&quot;docketsDT.csv&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>A quick glance at the resulting data frame (omitting the ID numbers,
defendants, dates, and attorney bar number):</p>
<div class="highlight"><pre>x.dockets <span class="o">&lt;-</span> xtable<span class="p">(</span><span class="kp">summary</span><span class="p">(</span>dockets.DT<span class="p">[,</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;violation&quot;</span><span class="p">,</span> <span class="s">&quot;plea&quot;</span><span class="p">,</span> 
                                          <span class="s">&quot;finding&quot;</span><span class="p">,</span> 
                                          <span class="s">&quot;attorney.is.assigned&quot;</span><span class="p">,</span> 
                                          <span class="s">&quot;attorney.is.private&quot;</span><span class="p">,</span> 
                                          <span class="s">&quot;attorney.name&quot;</span><span class="p">,</span> 
                                          <span class="s">&quot;pc.hearing.held&quot;</span><span class="p">,</span> 
                                          <span class="s">&quot;pc.found&quot;</span><span class="p">),</span> with <span class="o">=</span> <span class="kc">FALSE</span><span class="p">]),</span> 
                    caption <span class="o">=</span> <span class="s">&quot;Selected result summaries for the dockets table.&quot;</span>
                    <span class="p">)</span>
<span class="kp">print</span><span class="p">(</span>x.dockets<span class="p">,</span> type <span class="o">=</span> <span class="s">&quot;html&quot;</span><span class="p">)</span>
</pre></div>


<!-- html table generated in R 3.0.1 by xtable 1.7-1 package -->

<!-- Mon Aug 26 01:07:10 2013 -->

<TABLE border=1>
<CAPTION ALIGN="bottom"> 
Selected result summaries for the dockets table.
</CAPTION>
<TR> <TH>  </TH> <TH>                                         
violation
</TH> <TH>         
plea
</TH> <TH>       
finding
</TH> <TH> 
attorney.is.assigned
</TH> <TH> 
attorney.is.private
</TH> <TH> 
attorney.name
</TH> <TH> 
pc.hearing.held
</TH> <TH>  
pc.found
</TH>  </TR>
  <TR> <TD align="right"> 
1
</TD> <TD> 
BATTERY/DOMESTIC VIOLENCE : 6871
</TD> <TD> 
NONE :29640
</TD> <TD> 
GUILTY :33632
</TD> <TD> 
Mode :logical
</TD> <TD> 
Mode :logical
</TD> <TD> 
Length:63516
</TD> <TD> 
Mode :logical
</TD> <TD> 
Mode :logical
</TD> </TR>
  <TR> <TD align="right"> 
2
</TD> <TD> 
TRESPASSING : 6192
</TD> <TD> 
NOLO :19442
</TD> <TD> 
NONE :29640
</TD> <TD> 
FALSE:42513
</TD> <TD> 
FALSE:53745
</TD> <TD> 
Class :character
</TD> <TD> 
FALSE:40056
</TD> <TD> 
FALSE:254
</TD> </TR>
  <TR> <TD align="right"> 
3
</TD> <TD> 
UNLAWFUL USE/POSSESSION OF DRUG PARAPHERNALIA: 4697
</TD> <TD> 
GUILTY :11841
</TD> <TD> 
NOT GUILTY: 111
</TD> <TD> 
TRUE :18864
</TD> <TD> 
TRUE :7632
</TD> <TD> 
Mode :character
</TD> <TD> 
TRUE :23460
</TD> <TD> 
TRUE :23206
</TD> </TR>
  <TR> <TD align="right"> 
4
</TD> <TD> 
PETIT LARCENY : 3873
</TD> <TD> 
SUBMIT : 2100
</TD> <TD> 
Finding : 3
</TD> <TD> 
NA's :2139
</TD> <TD> 
NA's :2139
</TD> <TD>  </TD> <TD> 
NA's :0
</TD> <TD> 
NA's :40056
</TD> </TR>
  <TR> <TD align="right"> 
5
</TD> <TD> 
POSSESS LESS THAN 1 OUNCE OF MARIJUANA : 3836
</TD> <TD> 
NOT GUILTY: 342
</TD> <TD> 
NA's : 130
</TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> </TR>
  <TR> <TD align="right"> 
6
</TD> <TD> 
(Other) :38046
</TD> <TD> 
(Other) : 91
</TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> </TR>
  <TR> <TD align="right"> 
7
</TD> <TD> 
NA's : 1
</TD> <TD> 
NA's : 60
</TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> </TR>
   </TABLE>

<p>The most eyepopping result? The 111 acquittals, or 0.175 percent of
63516 cases total. That isn't very many at all. A closer look:</p>
<div class="highlight"><pre>acquitals <span class="o">&lt;-</span> dockets.DT<span class="p">[</span>finding <span class="o">==</span> <span class="s">&#39;NOT GUILTY&#39;</span><span class="p">,</span>
                        <span class="kt">c</span><span class="p">(</span><span class="s">&quot;violation&quot;</span><span class="p">,</span>
                          <span class="s">&quot;plea&quot;</span><span class="p">,</span>
                          <span class="s">&quot;finding&quot;</span><span class="p">,</span>
                          <span class="s">&quot;attorney.is.assigned&quot;</span><span class="p">,</span>
                          <span class="s">&quot;attorney.is.private&quot;</span><span class="p">,</span>
                          <span class="s">&quot;attorney.name&quot;</span><span class="p">,</span>
                          <span class="s">&quot;pc.hearing.held&quot;</span><span class="p">,</span>
                          <span class="s">&quot;pc.found&quot;</span><span class="p">),</span> 
                        with <span class="o">=</span> <span class="kc">FALSE</span><span class="p">]</span>
x.acq <span class="o">&lt;-</span> xtable<span class="p">(</span><span class="kp">summary</span><span class="p">(</span>acquitals<span class="p">),</span> caption <span class="o">=</span> <span class="s">&quot;Result summaries for the acquitals table.&quot;</span><span class="p">)</span>
<span class="kp">print</span><span class="p">(</span>x.acq<span class="p">,</span> type <span class="o">=</span> <span class="s">&quot;html&quot;</span><span class="p">)</span>
</pre></div>


<!-- html table generated in R 3.0.1 by xtable 1.7-1 package -->

<!-- Mon Aug 26 01:04:37 2013 -->

<TABLE border=1>
<CAPTION ALIGN="bottom"> 
Result summaries for the acquitals table.
</CAPTION>
<TR> <TH>  </TH> <TH>                                  
violation
</TH> <TH>         
plea
</TH> <TH>       
finding
</TH> <TH> 
attorney.is.assigned
</TH> <TH> 
attorney.is.private
</TH> <TH> 
attorney.name
</TH> <TH> 
pc.hearing.held
</TH> <TH> 
pc.found
</TH>  </TR>
  <TR> <TD align="right"> 
1
</TD> <TD> 
BATTERY/DOMESTIC VIOLENCE :43
</TD> <TD> 
NOT GUILTY:106
</TD> <TD> 
GUILTY : 0
</TD> <TD> 
Mode :logical
</TD> <TD> 
Mode :logical
</TD> <TD> 
Length:111
</TD> <TD> 
Mode :logical
</TD> <TD> 
Mode:logical
</TD> </TR>
  <TR> <TD align="right"> 
2
</TD> <TD> 
DUI LIQUOR :11
</TD> <TD> 
SUBMIT : 2
</TD> <TD> 
NONE : 0
</TD> <TD> 
FALSE:62
</TD> <TD> 
FALSE:56
</TD> <TD> 
Class :character
</TD> <TD> 
FALSE:89
</TD> <TD> 
TRUE:22
</TD> </TR>
  <TR> <TD align="right"> 
3
</TD> <TD> 
BATTERY : 7
</TD> <TD> 
GUILTY : 0
</TD> <TD> 
NOT GUILTY:111
</TD> <TD> 
TRUE :40
</TD> <TD> 
TRUE :46
</TD> <TD> 
Mode :character
</TD> <TD> 
TRUE :22
</TD> <TD> 
NA's:89
</TD> </TR>
  <TR> <TD align="right"> 
4
</TD> <TD> 
TRESPASSING : 6
</TD> <TD> 
NONE : 0
</TD> <TD> 
Finding : 0
</TD> <TD> 
NA's :9
</TD> <TD> 
NA's :9
</TD> <TD>  </TD> <TD> 
NA's :0
</TD> <TD>  </TD> </TR>
  <TR> <TD align="right"> 
5
</TD> <TD> 
POSSESS LESS THAN 1 OUNCE OF MARIJUANA: 3
</TD> <TD> 
NOLO : 0
</TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> </TR>
  <TR> <TD align="right"> 
6
</TD> <TD> 
RECKLESS DRIVING : 3
</TD> <TD> 
(Other) : 0
</TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> </TR>
  <TR> <TD align="right"> 
7
</TD> <TD> 
(Other) :38
</TD> <TD> 
NA's : 3
</TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> <TD>  </TD> </TR>
   </TABLE>

<p>And we can also generate top ten tables for all dockets and for
acquittals:</p>
<!-- html table generated in R 3.0.1 by xtable 1.7-1 package -->

<!-- Sun Aug 25 22:48:29 2013 -->

<TABLE border=1>
<CAPTION ALIGN="bottom"> 
Top ten violations for all dockets.
</CAPTION>
<TR> <TH>  </TH> <TH> 
Count
</TH>  </TR>
  <TR> <TD align="right"> 
BATTERY/DOMESTIC VIOLENCE
</TD> <TD align="right"> 
6871
</TD> </TR>
  <TR> <TD align="right"> 
TRESPASSING
</TD> <TD align="right"> 
6192
</TD> </TR>
  <TR> <TD align="right"> 
UNLAWFUL USE/POSSESSION OF DRUG PARAPHERNALIA
</TD> <TD align="right"> 
4697
</TD> </TR>
  <TR> <TD align="right"> 
PETIT LARCENY
</TD> <TD align="right"> 
3873
</TD> </TR>
  <TR> <TD align="right"> 
POSSESS LESS THAN 1 OUNCE OF MARIJUANA
</TD> <TD align="right"> 
3836
</TD> </TR>
  <TR> <TD align="right"> 
CONSUME ALCHOL ON PREMISE OFF/SALE ONLY
</TD> <TD align="right"> 
3238
</TD> </TR>
  <TR> <TD align="right"> 
BATTERY
</TD> <TD align="right"> 
3200
</TD> </TR>
  <TR> <TD align="right"> 
DUI LIQUOR
</TD> <TD align="right"> 
2860
</TD> </TR>
  <TR> <TD align="right"> 
OBSTRUCTING/FALSE INFO TO P. O.
</TD> <TD align="right"> 
1932
</TD> </TR>
  <TR> <TD align="right"> 
CONVICTED PERSON FAIL/CHANGE ADDRESS
</TD> <TD align="right"> 
1900
</TD> </TR>
   </TABLE>

<!-- html table generated in R 3.0.1 by xtable 1.7-1 package -->

<!-- Sun Aug 25 22:48:29 2013 -->

<TABLE border=1>
<CAPTION ALIGN="bottom"> 
Top ten violations for dockets of cases resulting in acquittal.
</CAPTION>
<TR> <TH>  </TH> <TH> 
Count
</TH>  </TR>
  <TR> <TD align="right"> 
BATTERY/DOMESTIC VIOLENCE
</TD> <TD align="right">  
43
</TD> </TR>
  <TR> <TD align="right"> 
DUI LIQUOR
</TD> <TD align="right">  
11
</TD> </TR>
  <TR> <TD align="right"> 
BATTERY
</TD> <TD align="right">   
7
</TD> </TR>
  <TR> <TD align="right"> 
TRESPASSING
</TD> <TD align="right">   
6
</TD> </TR>
  <TR> <TD align="right"> 
RECKLESS DRIVING
</TD> <TD align="right">   
3
</TD> </TR>
  <TR> <TD align="right"> 
POSSESS LESS THAN 1 OUNCE OF MARIJUANA
</TD> <TD align="right">   
3
</TD> </TR>
  <TR> <TD align="right"> 
NOISE DISTURBANCE
</TD> <TD align="right">   
2
</TD> </TR>
  <TR> <TD align="right"> 
DUI DRUGS CHEMICALS ORGANIC SOLVENT
</TD> <TD align="right">   
2
</TD> </TR>
  <TR> <TD align="right"> 
OBSTRUCTING/FALSE INFO TO P. O.
</TD> <TD align="right">   
2
</TD> </TR>
  <TR> <TD align="right"> 
PETIT LARCENY
</TD> <TD align="right">   
2
</TD> </TR>
   </TABLE>

<p>The other interesting result is the 1.08 percent of probable cause
hearings that failed to find probable cause.</p>
<h2>Sentencing</h2>
<p>Relatively straight forward. We have five columns (sentence name, cash
(T/F), due, paid, balance) to extract, and need only check for the
presence of a dollar sign in the second column, which indicates a fine.</p>
<div class="highlight"><pre>extractSentence <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>chr<span class="p">,</span> n<span class="p">)</span> <span class="p">{</span>
    <span class="c1"># Parses the case sentencing table (no. 4) of LVMC case reports</span>
    <span class="c1"># </span>
    <span class="c1"># Args: chr: filename or url pointing to case summary</span>
    <span class="c1"># </span>
    <span class="c1"># Returns: A data frame containing: id item.name cash - todo: character</span>
    <span class="c1"># dollar sign -&gt; logical due paid balance</span>
    sen.raw <span class="o">&lt;-</span> TreeParse<span class="p">(</span>chr<span class="p">)</span>
    sen.raw.df <span class="o">&lt;-</span> readHTMLTable<span class="p">(</span>sen.raw<span class="p">[[</span><span class="m">4</span><span class="p">]],</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> skip.rows <span class="o">=</span> <span class="m">2</span><span class="p">,</span> 
        header <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="p">,</span> <span class="s">&quot;cash&quot;</span><span class="p">,</span> <span class="s">&quot;due&quot;</span><span class="p">,</span> <span class="s">&quot;paid&quot;</span><span class="p">,</span> <span class="s">&quot;balance&quot;</span><span class="p">))</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>sen.raw.df<span class="p">)</span> <span class="o">==</span> <span class="m">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="kp">try</span><span class="p">(</span>sen.raw.df<span class="o">$</span>cash <span class="o">&lt;-</span> sen.raw.df<span class="o">$</span>cash <span class="o">%in%</span> <span class="s">&quot;$&quot;</span><span class="p">,</span> silent <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
        sents <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span><span class="m">.i</span>ds <span class="o">=</span> n<span class="p">,</span> sen.raw.df<span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
        sents <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span><span class="m">.i</span>ds <span class="o">=</span> n<span class="p">,</span> item <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> cash <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> due <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> paid <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> 
            balance <span class="o">=</span> <span class="kc">NA</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kr">return</span><span class="p">(</span>sents<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>And run it here, after checking to see whether our data file exists.</p>
<div class="highlight"><pre><span class="kr">if</span> <span class="p">(</span><span class="kp">file.exists</span><span class="p">(</span><span class="s">&quot;sentsDT.RData&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kp">load</span><span class="p">(</span><span class="s">&quot;sentsDT.RData&quot;</span><span class="p">)</span>
<span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
    sentences.l <span class="o">&lt;-</span> mclapply<span class="p">(</span><span class="kp">seq_along</span><span class="p">(</span>results.list<span class="p">),</span> <span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> <span class="p">{</span>
        extractSentence<span class="p">(</span>results.list<span class="p">[[</span>i<span class="p">]],</span> n <span class="o">=</span> <span class="kp">names</span><span class="p">(</span>results.list<span class="p">)[[</span>i<span class="p">]])</span>
    <span class="p">})</span>
    sents <span class="o">&lt;-</span> rbind.fill<span class="p">(</span>sentences.l<span class="p">)</span>
    sents.DT <span class="o">&lt;-</span> data.table<span class="p">(</span>sents<span class="p">,</span> key <span class="o">=</span> <span class="s">&quot;.ids&quot;</span><span class="p">)</span>
    <span class="kp">save</span><span class="p">(</span>sents.DT<span class="p">,</span> file <span class="o">=</span> <span class="s">&quot;sentsDT.RData&quot;</span><span class="p">,</span> compress <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
    write.csv<span class="p">(</span>sents.DT<span class="p">,</span> file <span class="o">=</span> <span class="s">&quot;sentsDT.csv&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>Not evaluated. So the first run:</p>
<div class="highlight"><pre>    <span class="o">&gt;</span> <span class="kp">system.time</span><span class="p">(</span>
    <span class="o">+</span> sentences.l <span class="o">&lt;-</span> mclapply<span class="p">(</span><span class="kp">seq_along</span><span class="p">(</span>results.list<span class="p">),</span> <span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> 
    <span class="o">+</span> <span class="p">{</span>
    <span class="o">+</span> extractSentence<span class="p">(</span>results.list<span class="p">[[</span>i<span class="p">]],</span> n<span class="o">=</span><span class="kp">names</span><span class="p">(</span>results.list<span class="p">)[[</span>i<span class="p">]]))</span>
    <span class="o">+</span> <span class="p">}</span>
    <span class="o">+</span> <span class="p">)</span>
       user  system elapsed 
    <span class="m">870.088</span>   <span class="m">9.112</span> <span class="m">436.309</span> 
    <span class="o">&gt;</span> 
    <span class="o">&gt;</span> 
    <span class="o">&gt;</span> <span class="kp">system.time</span><span class="p">(</span>
    <span class="o">+</span> sents <span class="o">&lt;-</span> rbind.fill<span class="p">(</span>sentences.l<span class="p">)</span>
    <span class="o">+</span> <span class="p">)</span>
        user   system  elapsed 
    <span class="m">2856.880</span>    <span class="m">3.672</span> <span class="m">2863.360</span> 
</pre></div>


<p>Which is obviously hosed. It would probably be faster to write each data
frame to disk and then paste or <code>cat</code> them together than to use
<code>rbind.fill</code>. The <code>parallel</code> package is particularly useful here for
parsing both the docket and sentence tables, cutting processing time in
half on my machine (an aging i5-650 dual-core CPU).</p>
<h2>Housekeeping</h2>
<div class="highlight"><pre><span class="kp">ls</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>##  [1] &quot;acquitals&quot;          &quot;acqviol.df&quot;         &quot;activitySplit&quot;     
##  [4] &quot;dockets.DT&quot;         &quot;extractDocket&quot;      &quot;extractIdentifiers&quot;
##  [7] &quot;extractSentence&quot;    &quot;getAttorney&quot;        &quot;GetProbableCause&quot;  
## [10] &quot;isClosed&quot;           &quot;isDenied&quot;           &quot;pairVectors&quot;       
## [13] &quot;parseAttorneyName&quot;  &quot;parseDocket&quot;        &quot;ParseSummaryTree&quot;  
## [16] &quot;results.list&quot;       &quot;sents.DT&quot;           &quot;TreeParse&quot;         
## [19] &quot;violdf&quot;             &quot;x.acq&quot;              &quot;x.acq.viol&quot;        
## [22] &quot;x.dockets&quot;          &quot;x.viol&quot;
</pre></div>


<div class="highlight"><pre>tables<span class="p">()</span>
</pre></div>


<div class="highlight"><pre>##      NAME          NROW MB
## [1,] acquitals      111 13
## [2,] dockets.DT  63,516 19
## [3,] sents.DT   329,070 18
##      COLS                                                                            
## [1,] history.number,case.number,citation.number,violation,violation.date,name,departm
## [2,] history.number,case.number,citation.number,violation,violation.date,name,departm
## [3,] .ids,item,cash,due,paid,balance                                                 
##      KEY        
## [1,] case.number
## [2,] case.number
## [3,] .ids       
## Total: 50MB
</pre></div>


<div class="highlight"><pre>sessionInfo<span class="p">()</span>
</pre></div>


<div class="highlight"><pre>## R version 3.0.1 (2013-05-16)
## Platform: x86_64-pc-linux-gnu (64-bit)
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=C                 LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
## [1] xtable_1.7-1     stringr_0.6.2    ggplot2_0.9.3.1  plyr_1.8        
## [5] data.table_1.8.8 XML_3.98-1.1     knitr_1.2       
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_1.2-2   dichromat_2.0-0    digest_0.6.3      
##  [4] evaluate_0.4.4     formatR_0.8        grid_3.0.1        
##  [7] gtable_0.1.2       labeling_0.2       MASS_7.3-27       
## [10] munsell_0.4.2      proto_0.3-10       RColorBrewer_1.0-5
## [13] reshape2_1.2.2     scales_0.2.3       tools_3.0.1
</pre></div>


<h2>Data</h2>
<p>I've posted the resulting files to
<a href="http://figshare.com/articles/Criminal_Misdemeanor_Dockets_from_the_Las_Vegas_Municipal_Court_2009_2013_/781307">Figshare</a>.<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup></p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="http://cos.name/">Xiao Nan</a> has a nice slide deck on web scraping
with R available
<a href="http://cos.name/wp-content/uploads/2013/05/Web-Scraping-with-R-XiaoNan.pdf">here</a>.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>This may need to change. I need to figure out whether "submittals"
that result in the case being dismissed (similar to <a href="http://en.wikipedia.org/wiki/Adjournment_in_contemplation_of_dismissal">Adjournment in
contemplation of
dismissal</a>)
belong with cases in which the DA denies the charge.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>James Estevez, "Criminal Misdemeanor Dockets from the Las Vegas
Municipal Court (2009-2013)", <em>FigShare</em> (August 8, 2013),
<a href="http://figshare.com/articles/Criminal_Misdemeanor_Dockets_from_the_Las_Vegas_Municipal_Court_2009_2013_/781307">Link</a>.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
<footer class="post-info">
  <p>Tags: 
    <a href="/tag/scraping.html">[scraping</a>
    <a href="/tag/r.html">R</a>
    <a href="/tag/dataset.html">dataset]</a>
  </p>

</footer><!-- /.post-info -->    </div><!-- /.entry-content -->

  </article>
</section>
        <div class="clear-footer"></div>
    </div>
    <footer id="contentinfo" class="body">
        <div class="social">
            <a href="mailto:james@jamesestevez.com" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-envelope fa-stack-1x dat-icon"></i>
                </span>
            </a>
            <a href="https://github.com/james-estevez" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x dat-icon"></i>
                </span>
            </a>
            <a href="https://twitter.com/jstvz" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x dat-icon"></i>
                </span>
            </a>
        </div>
        <p>
            ©2013 James Estevez
            <br/>Built with <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>.
        </p>
    </footer>

</body>
</html>
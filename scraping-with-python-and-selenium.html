<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>James Estevez | Scraping with Python and Selenium</title>
  <meta property="og:type" content="article" />
  <meta name="description" content="Case information from the Las Vegas Municipal Court can be accessed through an ASP.Net Web Form. Attempts to get this public data in bulk having been rebuffed, we'll be doing a bit of scraping. Bleech. Case lookup. Case lookup is available here. That page contains a frame with ..." />
    <link rel="stylesheet" href="/theme/css/main.css" />
    <link rel="stylesheet" href="/theme/fonts/main.css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body id="index" class="home">
    <div id="wrapper">
        <header id="banner" class="body">
            <h1><a href="/">James Estevez</a></h1>
            <br/><nav><ul>
            </ul></nav>
        </header>
<section id="content" class="body">
  <article class="container">
    <header>
      <h1 class="entry-title">Scraping with Python and Selenium</h1>
      <span class="date">Mon 26 August 2013</span>
    </header>

    <div class="entry-content">
      <p>Case information from the <a href="http://www.lasvegasnevada.gov/government/municipalcourt.htm">Las Vegas Municipal
Court</a> can
be accessed through an ASP.Net Web Form. Attempts to get this public
data in bulk having been <a href="/assets/files/LVMC-20130731.pdf">rebuffed</a>,
we'll be doing a bit of scraping. Bleech.</p>
<h2>Case lookup.</h2>
<p>Case lookup is available
<a href="http://www.lasvegasnevada.gov/Government/28413.htm">here</a>. That page
contains a
<a href="https://secure2.lasvegasnevada.gov/defendantreport/Default.aspx">frame</a>
with a single form element.</p>
<p>That form takes a single argument, 16 digits or less in length. I was
going to tackle this with the <code>mechanize</code> library. First run based on
the scraperwiki <a href="https://views.scraperwiki.com/run/python_mechanize_cheat_sheet/"><code>mechanize</code> cheat
sheet</a>:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">mechanize</span>

<span class="n">br</span> <span class="o">=</span> <span class="n">mechanize</span><span class="o">.</span><span class="n">Browser</span><span class="p">()</span> 
<span class="n">br</span><span class="o">.</span><span class="n">set_all_readonly</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># allow everything to be written to </span>
<span class="n">br</span><span class="o">.</span><span class="n">set_handle_robots</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># no robots </span>
<span class="n">br</span><span class="o">.</span><span class="n">set_handle_refresh</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># can sometimes hang without this </span>
<span class="n">br</span><span class="o">.</span><span class="n">addheaders</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;User-agent&#39;</span><span class="p">,</span> <span class="s">&#39;Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1) Gecko/2008071615 Fedora/3.0.1-1.fc9 Firefox/3.0.1&#39;</span><span class="p">)]</span> 
</pre></div>


<p>And get our target url:</p>
<div class="highlight"><pre><span class="n">target</span> <span class="o">=</span> <span class="s">&#39;https://secure2.lasvegasnevada.gov/defendantreport/Default.aspx&#39;</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>    <span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
    <span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;head&gt;&lt;title&gt;</span>
        City of Las Vegas Court Case Lookup
    <span class="nt">&lt;/title&gt;&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href=</span><span class="s">&quot;http://www.lasvegasnevada.gov/includes/stylesheetSmall.css&quot;</span> <span class="nt">/&gt;</span>

    [...]
</pre></div>


<p>We know that there's only one form, but let's see:</p>
<div class="highlight"><pre> 
<span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">br</span><span class="o">.</span><span class="n">forms</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;Form name:&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span>
    <span class="k">print</span> <span class="n">form</span>
</pre></div>


<div class="highlight"><pre>Form name: None
&lt;POST https://secure2.lasvegasnevada.gov/defendantreport/Default.aspx application/x-www-form-urlencoded
  &lt;HiddenControl(__EVENTTARGET=) (readonly)&gt;
  &lt;HiddenControl(__EVENTARGUMENT=) (readonly)&gt;
  &lt;HiddenControl(__VIEWSTATE=/wEPDwULLTE3MDc4NTU3NDBkZBFZvEXEM/AfxRuZRWuEEWJrOA5E0fGHGTe0sOVSnEAZ) (readonly)&gt;
  &lt;HiddenControl(__EVENTVALIDATION=/wEWAwLdxISPDgL43ua9AQK3leriC2s/4orhhWHuQloqbi0JGVVNeFua4wyBGgXiQ+jkAsML) (readonly)&gt;
  &lt;TextControl(txt_CaseNo=)&gt;
  &lt;SubmitControl(btn_GetCase=Get Report) (readonly)&gt;&gt;
</pre></div>


<p>As we expected, a single form. We'll select this form and iterate
through the controls:</p>
<div class="highlight"><pre><span class="n">br</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">br</span><span class="o">.</span><span class="n">forms</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">br</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controls</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">control</span>
    <span class="k">print</span> <span class="s">&quot;type=</span><span class="si">%s</span><span class="s">, name=</span><span class="si">%s</span><span class="s"> value=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">control</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">br</span><span class="p">[</span><span class="n">control</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre>&lt;HiddenControl(__EVENTTARGET=) (readonly)&gt;
type=hidden, name=__EVENTTARGET value=
&lt;HiddenControl(__EVENTARGUMENT=) (readonly)&gt;
type=hidden, name=__EVENTARGUMENT value=
&lt;HiddenControl(__VIEWSTATE=/wEPDwULLTE3MDc4NTU3NDBkZBFZvEXEM/AfxRuZRWuEEWJrOA5E0fGHGTe0sOVSnEAZ) (readonly)&gt;
type=hidden, name=__VIEWSTATE value=/wEPDwULLTE3MDc4NTU3NDBkZBFZvEXEM/AfxRuZRWuEEWJrOA5E0fGHGTe0sOVSnEAZ
&lt;HiddenControl(__EVENTVALIDATION=/wEWAwLdxISPDgL43ua9AQK3leriC2s/4orhhWHuQloqbi0JGVVNeFua4wyBGgXiQ+jkAsML) (readonly)&gt;
type=hidden, name=__EVENTVALIDATION value=/wEWAwLdxISPDgL43ua9AQK3leriC2s/4orhhWHuQloqbi0JGVVNeFua4wyBGgXiQ+jkAsML
&lt;TextControl(txt_CaseNo=)&gt;
type=text, name=txt_CaseNo value=
&lt;SubmitControl(btn_GetCase=Get Report) (readonly)&gt;
type=submit, name=btn_GetCase value=Get Report
</pre></div>


<p>More of the same. Create a single test number and submit our query:</p>
<div class="highlight"><pre><span class="n">test_num</span> <span class="o">=</span> <span class="s">&#39;C1002073A&#39;</span>
<span class="n">br</span><span class="p">[</span><span class="s">&quot;txt_CaseNo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_num</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">print</span> <span class="n">br</span><span class="o">.</span><span class="n">response</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span class="k">[...]</span>
<span class="err">&lt;div&gt;</span>
<span class="na">&lt;input name</span><span class="o">=</span><span class="s">&quot;txt_CaseNo&quot; type=&quot;text&quot; value=&quot;C1002073A&quot; maxlength=&quot;16&quot; id=&quot;txt_CaseNo&quot; style=&quot;font-size:12px;height:20px;width:175px;&quot; /&gt; &amp;nbsp;</span>
<span class="na">&lt;input type</span><span class="o">=</span><span class="s">&quot;submit&quot; name=&quot;btn_GetCase&quot; value=&quot;Get Report&quot; onclick=&quot;javascript:WebForm_DoPostBackWithOptions(new WebForm_PostBackOptions(&amp;quot;btn_GetCase&amp;quot;, &amp;quot;&amp;quot;, true, &amp;quot;&amp;quot;, &amp;quot;&amp;quot;, false, false))&quot; id=&quot;btn_GetCase&quot; class=&quot;formButton&quot; /&gt;&lt;br /&gt;</span>
<span class="na">&lt;span id</span><span class="o">=</span><span class="s">&quot;validMessage&quot; class=&quot;alertMssg&quot; style=&quot;display:none;&quot;&gt;Please enter a case ID&lt;/span&gt;</span>
<span class="na">&lt;span id</span><span class="o">=</span><span class="s">&quot;lblError&quot;&gt;&lt;/span&gt;</span>
<span class="err">&lt;/div&gt;</span>
<span class="k">[...]</span>
</pre></div>


<p>Which isn't what we wanted.</p>
<h3>Selenium deals with the Javascript for us</h3>
<p>It would appear that problem here is javascript. I'm too lazy to figure
out what's happening here so I'm going to just throw in a grenade:
<a href="http://docs.seleniumhq.org/">Selenium</a>.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
</pre></div>


<p>Needed to figure out exactly how Selenium works, so using a rough
approximation of the example on
<a href="http://selenium-python.readthedocs.org/en/latest/getting-started.html#">RTD</a>:</p>
<div class="highlight"><pre><span class="n">p</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">FirefoxProfile</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_preference</span><span class="p">(</span><span class="s">&quot;webdriver.log.file&quot;</span><span class="p">,</span> <span class="s">&quot;/tmp/firefox_console&quot;</span><span class="p">)</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">assert</span> <span class="s">&quot;City of Las Vegas Court Case Lookup&quot;</span> <span class="ow">in</span> <span class="n">driver</span><span class="o">.</span><span class="n">title</span>
</pre></div>


<p>Which works fine.</p>
<p>It would appear that our issue with getting the second page is that the
lookup spits out via a call to <code>window.open</code>, the problem being that it
uses <code>null</code> as the <code>window.title</code>. Looking up the pop-up window via the
page title is brittle at best, so I just pulled all the window handles
into a <code>for</code> loop and matched urls before writing the page source to
disk.</p>
<p>Got a new browser window with Selenium, so now let's define a function
to save our report to disk...</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_lvmc_case_report</span><span class="p">(</span><span class="n">caseNumber</span><span class="p">):</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">casenum</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s">&#39;txt_CaseNo&#39;</span><span class="p">)</span>
    <span class="n">casenum</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">caseNumber</span><span class="p">)</span>
    <span class="n">casenum</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="s">&quot;30000&quot;</span><span class="p">)</span>     

    <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="n">driver</span><span class="o">.</span><span class="n">window_handles</span><span class="p">:</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">switch_to_window</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">driver</span><span class="o">.</span><span class="n">current_url</span> <span class="o">==</span> <span class="s">&#39;https://secure2.lasvegasnevada.gov/defendantreport/report.aspx&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">caseNumber</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>               
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Wrote </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span>   
    <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>


<p>In order to test the scraper we'll need some case numbers. There exists
a multitude of arrest/mugshot sites, so that's not particularly
difficult. For this project I'll be using
<a href="http://www.jailbase.com/en/sources/nv-clv/">Jailbase</a>, given that it
produces an archived snapshot of the inmate entry used to source each
arrestee's page, as well as an API which we may make use of later. The
question then becomes whether or not the case number pattern holds true
for citations, <em>i.e.</em> those seizures that did not culminate in a
custodial arrest. Some manual checking shows at least two "CA"-numbers
from non-custodial arrests.</p>
<p>Also, reviewing our manual downloads leads me to notice that the case
numbers seem to be an arithmetic progression. I manually queried a
sequence of case numbers and all were hits so that simplified matters
considerably. We can use a list comprehension to generate the case
numbers and be reasonably sure that we'll get hits.</p>
<div class="highlight"><pre><span class="n">test_nums</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C1012474A&#39;</span><span class="p">,</span><span class="s">&#39;C101200474A&#39;</span><span class="p">,</span> <span class="s">&#39;C1096047A&#39;</span><span class="p">]</span>
<span class="n">test_seq</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;A&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1096048</span><span class="p">,</span> <span class="mi">1096051</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">test_seq</span>
</pre></div>


<div class="highlight"><pre>[&#39;C1096048A&#39;, &#39;C1096049A&#39;, &#39;C1096050A&#39;]
</pre></div>


<p>So <code>test_nums[1]</code> is a bad case number, one not found in the DB. When
this happens the server raises an alert message and fails to open a
<code>report.aspx</code> window. This fails relatively gracefully.</p>
<p>Now, to avoid hammering the city's server let's introduce a random wait,
then use a <code>for</code> loop:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
 
<span class="k">for</span> <span class="n">test_num</span> <span class="ow">in</span> <span class="n">test_nums</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">test_num</span>
    <span class="n">get_lvmc_case_report</span><span class="p">(</span><span class="n">test_num</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre>C1012474A
Wrote C1012474A.html
C101200474A
C1096047A
Wrote C1096047A.html
</pre></div>


<p>A quick inspection of the files shows HTML tables, which was what we
wanted. Now, let's try the sequential set:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">test_num</span> <span class="ow">in</span> <span class="n">test_seq</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">test_num</span>
    <span class="n">get_lvmc_case_report</span><span class="p">(</span><span class="n">test_num</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre>C1096048A
Wrote C1096048A.html
C1096049A
Wrote C1096049A.html
C1096050A
Wrote C1096050A.html
</pre></div>


<p><abbr title="Which Was What We Wanted">W<sup>5</sup></abbr>. Everything
else looks good. We'll run this over <code>range(1010001, 1099263, 1)</code> for a
total of 89,262 queries dating from 26 February 2010 to 3 August 2013.
I'll shorten the sleep time upper bound to three seconds, cutting five
days down to a day and a half.</p>
<p>Run it overnight and on Sunday and start work on parsing the tables into
a database tomorrow.</p>
<p>Final notes:</p>
<ol>
<li>Should add <code>gzip</code> compression on file save.</li>
<li>Progress bar or a counter would be nice.</li>
<li>The connection at home is spotty, and I may need/want to put this on
    EC2, so making the script take the range from the command line is
    the next logical step.</li>
<li>Running this in a second X session keeps it out of the way.</li>
</ol>
<p>And we finally start getting data, after making a public records request
for that very same data that took seven weeks to deny. Script took about
a half-hour to figure out. It's absurd that I thought I could just ask
the government to give it to me. If it's in the public domain, don't
ask, just take it.</p>
<p>Gist <a href="https://gist.github.com/james-estevez/6151466">here</a>.</p>
<footer class="post-info">

</footer><!-- /.post-info -->    </div><!-- /.entry-content -->

  </article>
</section>
        <div class="clear-footer"></div>
    </div>
    <footer id="contentinfo" class="body">
        <div class="social">
            <a href="mailto:james@jamesestevez.com" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-envelope fa-stack-1x dat-icon"></i>
                </span>
            </a>
            <a href="https://github.com/james-estevez" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x dat-icon"></i>
                </span>
            </a>
            <a href="https://twitter.com/jstvz" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x dat-icon"></i>
                </span>
            </a>
        </div>
        <p>
            ©2013 James Estevez
            <br/>Built with <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>.
        </p>
    </footer>

</body>
</html>